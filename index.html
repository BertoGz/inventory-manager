<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Manager + AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for in-browser JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Transformers.js (AI Model) -->
    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.0';
        
        // Skip local model checks since we are in a browser without a file system
        env.allowLocalModels = false;
        
        // Attach to window so our React app can use it
        window.pipeline = pipeline;
        window.transformersLoaded = true;
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 5px; border: 2px solid #0f172a; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Optimization for large lists */
        .virtual-scroller {
            content-visibility: auto;
        }

        /* Animations */
        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-subtle {
            animation: pulse-subtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Icons ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const FolderOpen = (props) => (
            <IconBase {...props}><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-3.25 7a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/></IconBase>
        );
        const Package = (props) => (
            <IconBase {...props}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconBase>
        );
        const Save = (props) => (
            <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>
        );
        const AlertCircle = (props) => (
            <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>
        );
        const ImageIcon = (props) => (
            <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>
        );
        const RefreshCw = (props) => (
            <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>
        );
        const Search = (props) => (
            <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>
        );
        const Brain = (props) => (
            <IconBase {...props}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></IconBase>
        );
        const X = (props) => (
            <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>
        );

        // --- Constants & Helpers ---

        const ROW_HEIGHT = 80; 
        const BUFFER_ITEMS = 5; 

        const RARITY_MAP = {
            0: { label: "Common", color: "text-gray-400 border-gray-600 bg-gray-800" },
            1: { label: "Rare", color: "text-blue-400 border-blue-600 bg-blue-900/20" },
            2: { label: "Ultra Rare", color: "text-purple-400 border-purple-600 bg-purple-900/20" },
            3: { label: "Legendary", color: "text-yellow-400 border-yellow-600 bg-yellow-900/20" }
        };

        // Cosine Similarity between two vectors
        // Used to determine how similar the meaning of the search query is to the item name
        function cosineSimilarity(a, b) {
            let dot = 0;
            for (let i = 0; i < a.length; i++) {
                dot += a[i] * b[i];
            }
            // Note: Since embeddings from this model are normalized, dot product is enough.
            // But we'll do full cosine just in case normalization varies.
            let magA = 0, magB = 0;
            for (let i = 0; i < a.length; i++) magA += a[i] * a[i];
            for (let i = 0; i < b.length; i++) magB += b[i] * b[i];
            
            return dot / (Math.sqrt(magA) * Math.sqrt(magB));
        }

        // --- Components ---

        const FileUploader = ({ onDataLoaded }) => {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const inputRef = useRef(null);

            useEffect(() => {
                if (inputRef.current) {
                    inputRef.current.setAttribute("webkitdirectory", "");
                    inputRef.current.setAttribute("directory", "");
                }
            }, []);

            const handleFolderSelect = async (e) => {
                setLoading(true);
                setError(null);
                
                try {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) throw new Error("No folder selected or folder is empty.");

                    const dataFile = files.find(f => f.name.toLowerCase() === "furniture_data.txt" || f.name.toLowerCase().endsWith(".json"));
                    if (!dataFile) throw new Error("Could not find 'furniture_data.txt' inside the selected folder.");

                    const imageMap = new Map();
                    files.forEach(file => {
                        if (file.type.startsWith('image/')) {
                            imageMap.set(file.name, URL.createObjectURL(file));
                        }
                    });

                    const text = await readFileAsText(dataFile);
                    const enrichedData = parseAndEnrichData(text);
                    
                    onDataLoaded(enrichedData, imageMap);

                } catch (err) {
                    console.error(err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const readFileAsText = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => resolve(event.target.result);
                    reader.onerror = (error) => reject(error);
                    reader.readAsText(file);
                });
            };

            const parseAndEnrichData = (rawText) => {
                let text = rawText.trim();
                if (text.endsWith(',') || text.endsWith(',]')) text = text.replace(/,(\s*\]?)$/, '$1');
                if (!text.startsWith('[') && text.includes('{')) text = `[${text}]`;

                try {
                    const json = JSON.parse(text);
                    if (!Array.isArray(json)) throw new Error("File content is not a JSON array.");

                    return json.map((item, idx) => ({
                        id: item.id || `temp-${idx}`,
                        ...item,
                        name: item.name || "Unknown Item",
                        image: item.image || "",
                        quantity: item.count !== undefined ? item.count : (item.quantity || 0), 
                        price: item.price !== undefined ? item.price : 0,
                        rarity: item.rarity !== undefined ? item.rarity : 0
                    }));
                } catch (e) {
                    throw new Error("Failed to parse JSON. Ensure the file contains a valid JSON array.");
                }
            };

            return (
                <div className="flex flex-col items-center justify-center h-full space-y-6 p-8 text-center bg-slate-950 text-slate-100 animate-in fade-in duration-700">
                    <div className="bg-slate-900/50 p-10 rounded-2xl border border-slate-800 shadow-2xl max-w-lg w-full backdrop-blur-sm">
                        <div className="bg-blue-500/10 p-4 rounded-full w-24 h-24 mx-auto mb-6 flex items-center justify-center">
                            <FolderOpen className="w-12 h-12 text-blue-500" />
                        </div>
                        
                        <h1 className="text-3xl font-bold mb-3 bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">
                            Import Inventory
                        </h1>
                        
                        <p className="text-slate-400 mb-8 leading-relaxed">
                            Select the folder containing your <code className="bg-slate-800 px-2 py-1 rounded text-blue-300 font-mono text-sm border border-slate-700">furniture_data.txt</code> file and its corresponding images.
                        </p>

                        <label className="relative group flex items-center justify-center px-6 py-4 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-xl cursor-pointer transition-all hover:scale-[1.02] active:scale-[0.98] w-full shadow-lg hover:shadow-blue-500/25">
                            {loading ? (
                                <div className="flex items-center gap-2">
                                    <RefreshCw className="w-5 h-5 animate-spin" />
                                    <span>Processing Data...</span>
                                </div>
                            ) : (
                                <span>Select Folder</span>
                            )}
                            <input 
                                ref={inputRef}
                                type="file" 
                                className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                onChange={handleFolderSelect}
                                disabled={loading}
                            />
                        </label>

                        {error && (
                            <div className="mt-6 p-4 bg-red-950/30 border border-red-900/50 text-red-200 rounded-lg text-sm flex items-start gap-3 text-left animate-in slide-in-from-top-2">
                                <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5 text-red-400" />
                                <span>{error}</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ItemRow = React.memo(({ item, index, style, imageMap, onUpdate }) => {
            const imageUrl = imageMap.get(item.image);
            const rarityStyle = RARITY_MAP[item.rarity] || RARITY_MAP[0];

            return (
                <div 
                    style={style} 
                    className="absolute w-full flex items-center border-b border-slate-800/50 hover:bg-slate-800/30 transition-colors px-4 group"
                >
                    <div className="w-12 text-slate-600 text-sm font-mono flex-shrink-0">{index + 1}</div>

                    <div className="w-20 h-20 p-2 flex-shrink-0">
                        <div className="w-full h-full rounded-lg bg-slate-800/50 border border-slate-700/50 overflow-hidden relative">
                            {imageUrl ? (
                                <img 
                                    src={imageUrl} 
                                    alt={item.name} 
                                    className="w-full h-full object-contain hover:scale-110 transition-transform duration-300" 
                                    loading="lazy"
                                />
                            ) : (
                                <div className="w-full h-full flex flex-col items-center justify-center text-slate-600">
                                    <ImageIcon className="w-5 h-5 opacity-40" />
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="flex-1 px-4 min-w-0">
                        <div className="font-medium text-slate-200 truncate group-hover:text-blue-300 transition-colors" title={item.name}>
                            {item.name}
                        </div>
                        <div className="text-xs text-slate-500 font-mono truncate mt-0.5" title={item.id}>
                            {item.id}
                        </div>
                    </div>

                    <div className="w-28 px-2">
                        <label className="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1 block">Qty</label>
                        <input 
                            type="number" 
                            className="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500/50 focus:outline-none text-right text-slate-200 transition-all"
                            value={item.quantity}
                            min="0"
                            onChange={(e) => onUpdate(item.actualIndex, 'quantity', parseInt(e.target.value) || 0)}
                        />
                    </div>

                    <div className="w-32 px-2">
                        <label className="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1 block">Price</label>
                        <div className="relative">
                            <span className="absolute left-2 top-1.5 text-slate-500 text-sm">$</span>
                            <input 
                                type="number" 
                                className="w-full bg-slate-900 border border-slate-700 rounded pl-5 pr-2 py-1.5 text-sm focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/50 focus:outline-none text-right text-slate-200 transition-all"
                                value={item.price}
                                placeholder="0"
                                min="0"
                                onChange={(e) => onUpdate(item.actualIndex, 'price', e.target.value)}
                            />
                        </div>
                    </div>

                    <div className="w-36 px-2">
                        <label className="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1 block">Rarity</label>
                        <select 
                            className={`w-full border rounded px-2 py-1.5 text-xs font-medium focus:outline-none appearance-none cursor-pointer transition-all ${rarityStyle.color} ${rarityStyle.bg || 'bg-slate-900'}`}
                            value={item.rarity}
                            onChange={(e) => onUpdate(item.actualIndex, 'rarity', parseInt(e.target.value))}
                        >
                            {Object.entries(RARITY_MAP).map(([val, config]) => (
                                <option key={val} value={val} className="bg-slate-800 text-slate-200">
                                    {config.label}
                                </option>
                            ))}
                        </select>
                    </div>
                </div>
            );
        });

        const VirtualList = ({ items, imageMap, onUpdateItem }) => {
            const containerRef = useRef(null);
            const [scrollTop, setScrollTop] = useState(0);
            const [containerHeight, setContainerHeight] = useState(0);

            useEffect(() => {
                if (!containerRef.current) return;
                const resizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        setContainerHeight(entry.contentRect.height);
                    }
                });
                resizeObserver.observe(containerRef.current);
                return () => resizeObserver.disconnect();
            }, []);

            const handleScroll = (e) => {
                setScrollTop(e.target.scrollTop);
            };

            const totalHeight = items.length * ROW_HEIGHT;
            const startIndex = Math.max(0, Math.floor(scrollTop / ROW_HEIGHT) - BUFFER_ITEMS);
            const endIndex = Math.min(
                items.length - 1,
                Math.floor((scrollTop + containerHeight) / ROW_HEIGHT) + BUFFER_ITEMS
            );

            const visibleItems = useMemo(() => {
                const rows = [];
                for (let i = startIndex; i <= endIndex; i++) {
                    const item = items[i];
                    // IMPORTANT: We pass index+1 for display, but item.actualIndex is used for updates
                    // This handles cases where the list is filtered (searched)
                    rows.push(
                        <ItemRow 
                            key={item.id || i} 
                            index={i}
                            item={item}
                            style={{ top: i * ROW_HEIGHT, height: ROW_HEIGHT }}
                            imageMap={imageMap}
                            onUpdate={onUpdateItem}
                        />
                    );
                }
                return rows;
            }, [startIndex, endIndex, items, imageMap, onUpdateItem]);

            return (
                <div 
                    ref={containerRef}
                    className="flex-1 overflow-y-auto relative bg-slate-950 scroll-smooth virtual-scroller"
                    onScroll={handleScroll}
                >
                    <div style={{ height: totalHeight, position: 'relative', width: '100%' }}>
                        {items.length > 0 ? visibleItems : (
                            <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-500 opacity-60">
                                <Search className="w-12 h-12 mb-2" />
                                <span className="text-lg">No matching items found</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            // Data & State
            const [data, setData] = useState(null);
            const [imageMap, setImageMap] = useState(null);
            
            // AI State
            const [pipeline, setPipeline] = useState(null);
            const [embeddings, setEmbeddings] = useState(null);
            const [indexingProgress, setIndexingProgress] = useState(0); // 0 to 100
            const [isAIReady, setIsAIReady] = useState(false);
            
            // Search State
            const [searchQuery, setSearchQuery] = useState("");
            const [searchResults, setSearchResults] = useState(null);
            const [isSearching, setIsSearching] = useState(false);

            // 1. Initialize Transformers Pipeline
            useEffect(() => {
                const initAI = async () => {
                    if (!window.pipeline) return; 

                    try {
                        // Load model (runs once)
                        // feature-extraction task converts text to vectors
                        // Xenova/all-MiniLM-L6-v2 is small (~40MB) and good for semantic search
                        const pipe = await window.pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', {
                            quantized: true // Use smaller quantized model
                        });
                        setPipeline(() => pipe);
                        setIsAIReady(true);
                    } catch (e) {
                        console.error("AI Model Init Failed:", e);
                    }
                };

                // Simple polling to wait for module script to load
                const checkInterval = setInterval(() => {
                    if (window.pipeline) {
                        clearInterval(checkInterval);
                        initAI();
                    }
                }, 100);

                return () => clearInterval(checkInterval);
            }, []);

            // 2. Index Data when Loaded
            useEffect(() => {
                if (!data || !pipeline || embeddings) return;

                const generateEmbeddings = async () => {
                    const vectors = [];
                    setIndexingProgress(0);
                    
                    // Process in chunks to avoid blocking UI
                    const CHUNK_SIZE = 10;
                    for (let i = 0; i < data.length; i += CHUNK_SIZE) {
                        const chunk = data.slice(i, i + CHUNK_SIZE);
                        const promises = chunk.map(async (item) => {
                            // Run model on item name
                            const output = await pipeline(item.name, { pooling: 'mean', normalize: true });
                            return output.data; // Float32Array
                        });
                        
                        const chunkVectors = await Promise.all(promises);
                        vectors.push(...chunkVectors);
                        
                        // Update progress
                        setIndexingProgress(Math.round(((i + CHUNK_SIZE) / data.length) * 100));
                        
                        // Yield to main thread
                        await new Promise(r => setTimeout(r, 0));
                    }
                    
                    setEmbeddings(vectors);
                    setIndexingProgress(100);
                };

                generateEmbeddings();
            }, [data, pipeline]);

            // 3. Search Logic
            useEffect(() => {
                if (!searchQuery.trim()) {
                    setSearchResults(null);
                    return;
                }

                if (!embeddings || !pipeline) {
                    // Fallback to simple text search if AI isn't ready
                    const lowerQuery = searchQuery.toLowerCase();
                    const filtered = data.filter(item => 
                        item.name.toLowerCase().includes(lowerQuery) || 
                        item.id.toLowerCase().includes(lowerQuery)
                    );
                    setSearchResults(filtered);
                    return;
                }

                const runSearch = async () => {
                    setIsSearching(true);
                    
                    // Embed query
                    const queryOutput = await pipeline(searchQuery, { pooling: 'mean', normalize: true });
                    const queryVector = queryOutput.data;

                    // Calculate scores
                    const scoredItems = data.map((item, index) => {
                        const score = cosineSimilarity(queryVector, embeddings[index]);
                        return { ...item, score, actualIndex: index }; // Keep track of original index
                    });

                    // Sort by score descending
                    scoredItems.sort((a, b) => b.score - a.score);

                    // Filter threshold (e.g., extremely irrelevant items)
                    // For "Tile" -> "Floor", score might be 0.4-0.6. 
                    // Random words might be 0.0-0.1.
                    const filtered = scoredItems.filter(item => item.score > 0.15);

                    setSearchResults(filtered);
                    setIsSearching(false);
                };

                // Debounce
                const timeoutId = setTimeout(runSearch, 300);
                return () => clearTimeout(timeoutId);

            }, [searchQuery, embeddings, pipeline, data]);


            // Handlers
            const handleDataLoaded = (loadedData, loadedImages) => {
                // Add actualIndex property to allow updates to map back to original array
                const indexedData = loadedData.map((d, i) => ({...d, actualIndex: i}));
                setData(indexedData);
                setImageMap(loadedImages);
                setEmbeddings(null); // Reset embeddings for new data
            };

            const handleUpdateItem = useCallback((actualIndex, field, value) => {
                setData(prevData => {
                    const newData = [...prevData];
                    newData[actualIndex] = { ...newData[actualIndex], [field]: value };
                    return newData;
                });
            }, []);

            const handleExport = () => {
                if (!data) return;
                const exportData = data.map(({actualIndex, score, ...item}) => item); // Remove internal props
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "text/plain" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "furniture_data_updated.json";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleReset = () => {
                if (confirm("Are you sure? Unsaved changes will be lost.")) {
                    if (imageMap) imageMap.forEach(url => URL.revokeObjectURL(url));
                    setData(null);
                    setImageMap(null);
                    setEmbeddings(null);
                    setIndexingProgress(0);
                    setSearchQuery("");
                }
            };

            // Determine what to display
            const displayItems = searchResults || data;

            return (
                <div className="flex flex-col h-screen w-full bg-slate-950 text-slate-100 font-sans overflow-hidden">
                    <div className="bg-slate-900 border-b border-slate-800 px-6 py-4 flex items-center justify-between shadow-xl z-10 shrink-0 gap-4">
                        {/* Left: Logo & Title */}
                        <div className="flex items-center space-x-3 shrink-0">
                            <div className="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-900/20">
                                <Package className="text-white w-5 h-5" />
                            </div>
                            <div className="hidden md:block">
                                <h1 className="text-lg font-bold tracking-tight text-white">Inventory Manager</h1>
                                {data && (
                                    <div className="flex items-center gap-2 mt-0.5">
                                        <span className="bg-slate-800 text-slate-400 text-[10px] px-1.5 py-0.5 rounded border border-slate-700">
                                            {data.length.toLocaleString()} items
                                        </span>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Center: Search Bar & AI Status */}
                        {data && (
                            <div className="flex-1 max-w-xl relative group">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <Search className={`w-4 h-4 ${isSearching ? 'text-blue-400 animate-pulse' : 'text-slate-500'}`} />
                                </div>
                                <input 
                                    type="text"
                                    className="block w-full pl-10 pr-10 py-2 border border-slate-700 rounded-xl leading-5 bg-slate-800 text-slate-300 placeholder-slate-500 focus:outline-none focus:bg-slate-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all sm:text-sm"
                                    placeholder={embeddings ? "Search (e.g. 'Office chair' finds 'Stool')" : "Searching by text..."}
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                />
                                {searchQuery && (
                                    <button 
                                        className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-500 hover:text-white"
                                        onClick={() => setSearchQuery('')}
                                    >
                                        <X className="w-4 h-4" />
                                    </button>
                                )}
                                
                                {/* AI Status / Progress Bar */}
                                {indexingProgress < 100 && indexingProgress > 0 && (
                                    <div className="absolute -bottom-3 left-0 w-full h-1 bg-slate-800 rounded-full overflow-hidden">
                                        <div 
                                            className="h-full bg-blue-500 transition-all duration-300"
                                            style={{ width: `${indexingProgress}%` }}
                                        />
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Right: Actions */}
                        {data && (
                            <div className="flex items-center space-x-3 shrink-0">
                                {/* AI Indicator */}
                                <div className="flex items-center gap-2 px-3 py-1.5 bg-slate-800/50 rounded-lg border border-slate-800" title={embeddings ? "AI Ready" : "Loading Model..."}>
                                    <Brain className={`w-4 h-4 ${isAIReady ? 'text-purple-400' : 'text-slate-600 animate-pulse'}`} />
                                    {indexingProgress < 100 && indexingProgress > 0 && (
                                        <span className="text-[10px] text-slate-400 hidden sm:inline">{indexingProgress}%</span>
                                    )}
                                </div>

                                <button 
                                    onClick={handleReset}
                                    className="hidden sm:block px-4 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors"
                                >
                                    Reset
                                </button>
                                <button 
                                    onClick={handleExport}
                                    className="flex items-center space-x-2 bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all shadow-lg hover:shadow-emerald-500/20 hover:scale-105 active:scale-95"
                                >
                                    <Save className="w-4 h-4" />
                                    <span className="hidden sm:inline">Export</span>
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="flex-1 overflow-hidden relative flex flex-col">
                        {!data ? (
                            <FileUploader onDataLoaded={handleDataLoaded} />
                        ) : (
                            <>
                                <div className="flex items-center bg-slate-900/80 backdrop-blur border-b border-slate-800 px-4 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider shrink-0 select-none">
                                    <div className="w-12">#</div>
                                    <div className="w-20 text-center">Preview</div>
                                    <div className="flex-1 px-4">Item Details {searchQuery && `(Found ${displayItems.length})`}</div>
                                    <div className="w-28 px-2">Stock</div>
                                    <div className="w-32 px-2">Price</div>
                                    <div className="w-36 px-2">Rarity</div>
                                </div>
                                
                                <VirtualList 
                                    items={displayItems} 
                                    imageMap={imageMap} 
                                    onUpdateItem={handleUpdateItem} 
                                />
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>